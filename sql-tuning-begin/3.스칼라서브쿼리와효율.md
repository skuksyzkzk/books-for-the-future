# 3. 스칼라 서브쿼리의 이해와 효율적인 SQL 작성하기

## 스칼라 서브쿼리 이해하기 

스칼라 서브쿼리의 "최대"반복 횟수는 SQL의 결과 건수이다. 여기서 주목해야 할 점은 최대라는 단어이다. 스칼라 서브쿼리는 Deterministic하다. 즉 동일한 입력값에 대해서는 결과값이 항상 같다.

그래서 동일한 입력값이 오면 실제로는 결과값을 Multi Buffer에 저장하여 거기서 읽어온다.

### 추출되는 건수는 1건만 유효하다.

스칼라 서브쿼리로 추출되는 건수는 1건을 초과하면 오류가 생긴다.

> 그래서 만약 스칼라서브쿼리에서 조회되는 건수가 1건을 초과한다면, ROWNUM <= 1 조건으로 한건만 추출되게 해야한다.

### NULL 데이터가 추출되어도 SQL수행에는 지장이 없다.

즉 위의 스칼라 서브쿼리의 특성은 곧 스칼라 서브쿼리가 SQL의 추출건수에 영향을 미치지 않는 다는 것을 알 수 있다.

그렇기에 스칼라 서브쿼리를 조인으로 변경시에는 Outer Join으로 수행하며, 조인 연결 컬럼이 중복값을 가지면 안되는 것이다.

## 스칼라 서브쿼리와 조인 

스칼라 서브쿼리가 문제가 생기는 이유는 2가지다.

1. 스칼라 서브쿼리의 위치 
2. 스클라 서브쿼리와 조인과의 관계 

### 1. 스칼라 서브쿼리의 위치 

**스칼라 서브쿼리는 최종결과만큼 수행하자.**

이게 핵심이다. 위치를 잘못위치하여 최종결과만큼이 아닌 테이블 FULL 스캔을 한 결과에 스칼라 서브쿼리를 작성하게되면 성능 저하를 유발한다.

최종 조회된 결과가 10건이면 10번만 스칼라 서브쿼리가 수행되어야 문제가 없다.

나중에 테이블간에 조인이나 스칼라 서브쿼리의 위치도 결국 이렇게 최종 결과 만큼만 수행되도록 튜닝하는 것이다.

### 2. 조인과의 관계

#### 비효율적인 스칼라 서브쿼리는 조인으로 변경하자

왜냐 대부분 배치 프로그램에서 select 되는 수들은 기본 50만건을 넘기에, 이런경우에는 스칼라서브쿼리의 입려값이 유니크하다면 결국 그 서브쿼리는 50만번 실행되는 것이므로 성능에 악영향을 끼친다.

### 🚩🚩 중요
**그러므로 최종 추출건수가 많고(= 수행횟수가 많은 경우) Outer Join + Hash Join으로 변경하자 !!**

> 하지만 반대로 조인을 스칼라 서브쿼리로 바꿔야 하는 경우도 존재한다. 이런경우는 추출되는 건수가 작은 데, 조인으로 인해서 비효율적인 접근이 발견되었을 경우이다.
>
> 이런 경우에는 조인을 스칼라 서브쿼리로 바꿔야된다.