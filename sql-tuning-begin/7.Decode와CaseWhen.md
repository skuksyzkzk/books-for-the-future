# 7 . Decode 와 Case When 

## DECODE

#### DECODE(입력값,결과값1,정답1,결과값2,정답2,디폴트ELSE값)

디코드를 통해서 조건을 사용하는 것이 많다. 중첩해서 처리하기도하고 내가 가장많이 본 함수도 역시 DECODE 였다.

## DECODE의 성능이슈

### 1. 로우를 컬럼으로 변환시

로우를 컬럼으로 변환한다는 말은 예를 들어, 판매 데이터가 이렇게 저장되어 있다고 가정해 보세요.

| 상품ID | 속성 | 값         |
| ------ | ---- | ---------- |
| 1001   | 색상 | 빨강       |
| 1001   | 크기 | M          |
| 1001   | 소재 | 면         |
| 1002   | 색상 | 파랑       |
| 1002   | 크기 | L          |
| 1002   | 소재 | 폴리에스터 |

이대로 두면 “상품 1001의 색상·크기·소재를 한눈에 보기”가 불편하겠죠?
이를 이렇게 바꿔주는 게 “행→컬럼 변환”입니다.

| 상품ID | 색상 | 크기 | 소재       |
| ------ | ---- | ---- | ---------- |
| 1001   | 빨강 | M    | 면         |
| 1002   | 파랑 | L    | 폴리에스터 |


**주로 어떤 금액이나 이런것을 조건에 따라서 SUM** 해야될 경우 발생합니다.

또한 이런경우 주로 서브쿼리를 사용해서 수행하는 데, 그것보다 decode를 사용하는 것이 좋습니다. 해당 테이블을 한번 읽고 수행하기 때문이죠.

### DECODE시 생기는 비효율은 뭘까?

DECODE시 생기는 비효율은 ELSE값 즉 default값을 주었을 때입니다.
이러면 당연히 if - else - end 에서 if - end 이 두가지만 보더라도 어떤 것이 더 효율적인 것은 알수있습니다.

그래서 흔히 SUM을 할 경우 null+숫자는 null이기에 걱정 때문에 defualt값을 부여하지만

sum(1+null) 이런 경우가 아니라 그냥 sum(value) 하는 value들 값에 null이 포함되어도, 정상적으로 null을 제외하고 집계합니다.

만약 전부 null인 상황이 걱정됨면 SUM 바깥부분에 NVL함수를 한번만 실행되도록 작성하는 게 중요합니다.

### 2. DECODE의 사용으로 인덱스를 사용못하게 되는 경우

예를 들어서 where empno = DECODE(b1,NULL,empno,b2) 이런식으로 있다고 하면

만약 b1이 NULL일 경우는 empno를 써서 테이블 풀스캔을하고 아닐 경우에는 b2값을 이용해서 인덱스 스캔을 하고 싶었을 것이다.

하지만 이러면 NULL이아니여도 풀스캔을 하게되어 비효율적이다.

여기서 알아보는 인덱스 풀 스캔과 레인지 스캔
 
 |                    | 인덱스 풀 스캔                                                      | 인덱스 범위 스캔                                  |
 | ------------------ | ------------------------------------------------------------------- | ------------------------------------------------- |
 | **작업 대상 범위** | 인덱스 전체                                                         | 인덱스의 일부(특정 키 범위)                       |
 | **I/O 패턴**       | 순차적(Sequential)                                                  | 랜덤에 가깝지만, 필요한 블록만                    |
 | **적합한 상황**    | - 커버링 인덱스로 모든 컬럼 조회<br>- 결과가 대량(인덱스 전체 근접) | - WHERE 절로 좁은 범위 필터링<br>- 적은 건수 조회 |
 | **성능 고려**      | 인덱스만으로 처리되면 빠르지만, 전체 읽어야 함                      | 범위가 작으면 I/O·CPU 절감 효과 큼                |
    


그리하여 기존의 where empno = DECODE(b1,NULL,empno,b2) 를 개선한다면
```sql
select * from t1 where empno = b1 and b1 IS NOT NULL 
UNION ALL
select * from t1 where empno = empno and b1 IS NULL
```

이런식으로 개선이된다. 그러면 여기서 의문이 생기는게 이러면 테이블을 2번 읽는 것아니냐고 생각 할 수 도있지만 알다시피 어처피 쿼리가 실행되는 순서는 where이 더 빠르기에 실제로는 where의 조건에서 걸러져서 한번만 실행된다.


