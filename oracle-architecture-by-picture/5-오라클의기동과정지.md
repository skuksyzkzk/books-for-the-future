# 5. 오라클의 기동과 정지

### 배워야 되는 이유

오라클의 기동과 정지를 배우는 이유는 기동할 때 어떤 파일을 어떻게 사용하고, 의존 관계가 어떻게 되는지 안다면 내부동작을 쉽게 이해할수 있고, 장애시 대응에도 도움이 된다.

# ✨ 1. 기동과 정지의 개요

오라클이 "창고 회사"라고 생각하면, 창고 회사의 업무 시작이 오라클의 기동이고
창고 회사의 업무가 종료되는 것이 오라클의 정지입니다.

### 창고 회사 업무 시작 (오라클 기동)
1. 사원(영업 제외)이 출근함
2. 창고에 관한 정보(관리 대장)를 조사함
3. 창고를 대충 훑어본 뒤, 문제가 없다면 창고를 열어 업무를 시작함

### 창고 회사 업무 종료 (오라클 정지)
1. 업무(SQL이나 트랜잭션)가 끝나는 것을 기다린다.
2. 작업장의 물건(캐시상의 데이터)을 창고(파일)에 정리한다.
   1. **급할때는 1번2번을 기다리지않고 바로 종료한다.**
3. 사원이 퇴근함(프로세스 종료)

![image](https://github.com/user-attachments/assets/d8c8fc61-60a5-4c7c-886b-3b26456feae1)

# 🗽 2. 오라클 기동

기동시 출근하는 사원은 서버프로세스를 담당하는 영업 사원과 다릅니다.

기동시에 창고 직원이 출근하여 관리 대장을 확인하여 문제가 없으면 업무를 시작합니다.

여기서 창고 직원의 출근이 **백그라운드 프로세스의 생성 + 공유 메모리의 확보**

관리 대장을 보는 것이 **컨트롤 파일을 보는 것**을 의미합니다.

> 📕 **컨트롤 파일**
>
> 데이터베이스의 구성정보가 적혀 있는 파일로서 데이터베이스의 파일 경로를 알 수 있다.

창고를 열어서 업무를 시작하는 것이 SQL을 처리할 수 있는 상태로 만드는 작업.

# 🪟 3. 인스턴스, 데이터베이스, 주요 파일의 구성 

오라클의 인스턴스는 `백그라운드 프로세스 + 공유 메모리`를 의미합니다.
![image](https://github.com/user-attachments/assets/732a3a44-a230-413f-865c-7741b57d5f6a)


일반적으로 인스턴스와 데이터베이스는 1대1 대응하지만 RAC 같은 경우는 인스턴스와 데이터베이스는 1대1 대응이 안될수 있다.

일반적으로 환경변수 **ORACLE_HOME과 ORACLE_SID**를 알고 있을 경우, 나머지는 파일에 기록된 정보로 파일 경로 찾기 가능함.

![image](https://github.com/user-attachments/assets/a5e8cd10-7bbe-44b6-820c-b7d887c3cbef)


# ✨ 4. 기동 처리 흐름 

## 1. 기동 정지 -> NOMOUNT 

`startup nomount` 명령어 실행시 ORACLE_HOME과 ORACLE_SID 환경 변수를 토대로 초기화 파라미터 파일을 찾아서 읽어 온다.
파일에서 읽어온 파라미터를 토대로 공유 메모리를 확보 백그라운드 프로세스를 생성합니다.

## 2. NOMOUNT -> MOUNT 
`alter database mount` 명령어 입력시 초기화 파라미터에 기술된 컨트롤 파일의 경로를 사용

**컨트롤 파일을 열어서 내용을 읽어 옵니다**

**REDO 로그 파일이나 데이터 파일의 위치를 파악합니다**



## 3. MOUNT -> OPEN

`alter database oepn` 명령어 입력시 데이터 파일을 열어서 간단한 점검후 백그라운드 프로세스를 가동합니다.

업무가 개시되는 상태입니다.

### 실제로는 startup만 입력해도 기동정지 -> OPEN이 됩니다.


### 😁 초기화 파라미터 파일 -> 컨트롤 파일 -> 데이터 파일 

> 오라클의 프로그램은 ORACLE_HOME이라고 불리는 경로 아래의 bin안에 들어있다.
>
> 여러 버전을 설치해야할 경우, bin아래 버전별 경로를 다르게 해야된다.

## ⚠️ 기동처리의 요점

1. 처음 초기화 파라미터를 읽어서 백그라운드 프로세스를 생성하고 공유메모리를 확보.
   1. **NOMOUNT** 
2. 초기화 파라미터 파일에 입력된 컨트롤 파일의 위치 확인 및 데이터 파일 윛치 확인.
   1. **MOUNT**
   2. 이떄는 데이터 파일이 없어도 에러 발생 안함.
3. 데이터 파일이나 REDO 로그 파일에 문제 없다면 데이터 파일을 읽고 기록할 수 있는 상태로 전환.
   1. **OPEN**
   2. 즉 SQL을 실행할 수 있는 상태
   

# 📗 5. 오라클 정지

`shutdown` 명령어 입력시 기동의 역순으로 중지됩니다.

그러나 이 과정에서 버퍼캐시에 분산된 데이터를 정리합니다.

예전에 언급되었던 오라클은 바로바로 기록을 하지 않기에, 정지 전에 변경된 데이터를 데이터파일에 기록하는 것입니다.

또한 shutdown시 변경된 데이터 기록을 안하고 급하게 종료할 수 도 있습니다.

이럴때 DBMS는 데이터를 잃어버리면 안되기에 REDO 로그 파일에 변경된 내용이 기록되어 있는 것을 자동으로 다음번 기동시에 복구합니다.

# 요약 

### Q. 컨트롤 파일이 손상 되었을 시 컨트롤 파일을 생성하기 위해서 명령어를 사용할 수 있다. 어떤 상태에서 이 명령어가 사용가능할까?

-> 컨트롤 파일이 손상되면 MOUNT할 수 가없다. 그렇기에 NOMOUNT상태에서 컨트롤 파일을 생성해야된다.

### Q. 데이터베이스의 파일이 손상되었을때는 복구작업을 수행해야된다. 중요한 데이터 파일이 손상되어 데이터베이스를 OPEN할 수 없을 때 어떤 상태에서 복구를 수행해야될까?

-> 데이터 파일의 위치를 알아야 복구가 가능하다.즉 MOUNT 상태에서 복구해야된다.

